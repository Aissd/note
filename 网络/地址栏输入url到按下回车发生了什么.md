https://mp.weixin.qq.com/s/cvbLt_C2ofKOJkn3p2g3sg

### 从浏览器地址栏输入url到按下回车发生了什么
> 从浏览器地址栏输入地址按下回车，可以看做是一次请求的发起，那么必然会经历以下几个步骤：

1、解析url地址
2、DNS解析
3、TCP链接
4、发送http请求
5、服务器接收请求
6、服务器响应
7、TCP链接断开
8、浏览器解析资源

> 浏览器可以发送请求的方式不止地址栏输入地址这种，比如a标签，img，link，script，form表单，ajax，fetch等等，这些方式都可以发送http请求，都会经历上述的过程，最终拿到资源，只是拿到资源的类型不一样，那么浏览器的处理方式也不一样。

#### 1、解析url
* 协议：一般是http或者https。
* 域名：baidu.com也可以是ip地址，域名最后也是会被解析为ip地址【ip地址的作用就是在互联网中确定服务器的位置】
* 端口：确定在服务器中运行的具体程序。
* 路径：/public/course，表示的是在该程序中资源的具体标识
* 查询参数：?id=123&pwd=456，作用主要是为了发送数据

#### 2、DNS解析
DNS解析其实就是**根据域名找到其绑定的ip地址**
查找顺序是：
> 浏览器缓存 => 操作系统缓存 => 路由器缓存 => ISP DNS缓存 => 根域名服务器

DNS查找过程解析：
1、浏览器会先检查是否存在缓存，若访问过一次域名后，会把结果缓存在浏览器中；
2、操作系统也会有自己的DNS缓存，但会在这之前检查域名是否存在于本地的Hhosts文件夹中；
3、路由器也会有自己的缓存；
4、IPS DNS缓存，就是在客户端电脑上设置的首选DNS服务器；
5、在前边所有的情况下都没有找到缓存的情况下，会连接互联网，把请求转发到互联网的根域；

#### 3、TCP连接
确定好目标服务器的ip地址和端口号后，就开始和远程服务器建立TCP连接
* 发送方：发送消息，等待...
* 接收方：接收消息，并给发送方回信，此时发送方接收到消息后，从发送方的角度就可以明白自己的消息是可以发送过去的。【但是接收方还不能确定自己的消息是否可以正常发送。】
* 发送方：接收到发送方的回信后，再给接收方发一个消息，此时从接收方的角度就能明白自己的消息可以正常发送

#### 4、发送http请求
http协议是建立在tcp/ip协议之上，tcp保证连接通畅，http就可以正常的进行和响应了。首先http请求是一个无状态的请求，且只能由浏览器主动发起，服务器进行响应。
浏览器发送请求的报文会携带以下信息：
* 请求路径，查询参数，请求方法，请求头，请求体

#### 5、服务器接收请求
在服务端会监听浏览器端发送的http请求，当浏览器的请求发出后，服务端就会接受该请求，并解析出相应的信息，选择对应的逻辑进行处理（比如查询对应的静态页面，保存文件，操作数据库，转发...），并将处理的结果响应给浏览器端

#### 6、服务器响应
服务器执行完逻辑之后，需要给浏览器响应内容（无论是要从服务器获取数据，还是在服务器做了什么操作，都要给浏览器一个响应）
响应一般包含：
* 状态码，状态文本，响应头，响应体

#### 7、TCP连接断开
1、浏览器端发消息通知服务器现在需要断开（第一次挥手）
2、服务器接到要断开的请求之后，给浏览器返回消息，告诉浏览器我正在准备释放（第二次挥手）
3、当服务器释放完成后，再通知浏览器我已经释放完成了（第三次挥手）
4、浏览器接到服务器释放完成的消息后，再给服务器发送消息告诉服务器我已经知道你释放完成了，服务器收到消息后，就能确认自己释放完成的消息已经通知到了（第四次挥手）

#### 8、浏览器解析资源
当浏览器接收到服务器响应的资源后，会对资源进行解析
1、首先，查看响应头，根据响应头的指示做不同的事情，比如重定向，存储cookie，解压gzip，缓存资源等等；
2、接下来获取MIME类型（查看响应头的content-type的值），根据不同的资源类型采用不同的解析方式）

#### 9、渲染页面
![img](https://mmbiz.qpic.cn/mmbiz_png/pfCCZhlbMQSWI6tXYpA48tDyPDwOBktMsWJsVicl3f1bm7Qia6wprbg6QtlL1QHECXRTu01u1dcON06iag2pfz92g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 10、http页面的加载
首先要知道浏览器解析是从上往下一行一行地解析的。
1、解码：传输回来的其实是一些二进制字节数据，浏览器需要根据文件指定编码（例如UTF-8）转换成字符串，也就是HTML代码
2、预解析：预解析做的事情是提前加载资源，减少处理时间，它会识别一些会请求资源的属性，比如img标签，并将这个请求加到请求队列中；
3、符号化：符号化是词法分析的过程，将输入解析成符号，HTML符号包括，开始标签，结束标签，属性名和属性值。它通过一个状态机去识别符号的桩体，比如遇到<，>状态都会产生变化
4、构建树：在上一步符号化中，解析器获得这些标记，然后以合适的方法创建DOM对象并把这些符号插入到DOM对象中

#### 11、css解析
一旦浏览器下载了 CSS，CSS 解析器就会处理它遇到的任何 CSS，根据语法规范解析出所有的 CSS 并进行标记化，然后我们得到一个规则表。
在匹配一个节点对应的 CSS 规则时，是按照从右到左的顺序的，例如：div p { font-size :14px }会先寻找所有的p标签然后判断它的父元素是否为div。
**所以我们写 CSS 时，尽量用 id 和 class，千万不要过度层叠**

#### 12、JavaScript编译执行

![img](https://mmbiz.qpic.cn/mmbiz_png/pfCCZhlbMQSWI6tXYpA48tDyPDwOBktMZYuKsfsRd0x8TvgFhhT78eXWbK7DMm6hHeEYGZ9S3O6K37n5hO47rw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

1、词法分析：js脚本加载完毕后，会首先进入语法分析阶段，它首先会分析代码块的语法是否正确，不正确则抛出“语法错误”，停止执行。
2、预编译：js有三种运行环境分别是 全局环境，函数环境，eval。每进入一个不同的运行环境都会创建一个对应的执行上下文，根据不同的上下文环境，形成一个函数调用栈，栈底永远是全局执行上下文，栈顶则永远是当前执行上下文。
3、执行：js虽然是单线程的，但是实际参与工作的线程一共有四个：JS引擎线程（主），事件触发线程，定时器触发线程，HTTP异步请求线程